<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="OPA for User Registration" /><meta name="author" content="Michal Kepkowski" /><meta property="og:locale" content="en" /><meta name="description" content="Open Policy Engine (OPA) for user registration." /><meta property="og:description" content="Open Policy Engine (OPA) for user registration." /><link rel="canonical" href="/posts/opa-registration/" /><meta property="og:url" content="/posts/opa-registration/" /><meta property="og:site_name" content="CyberSoup" /><meta property="og:image" content="/assets/img/2024/opa-registration/blog.opa.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-06-30T04:00:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="/assets/img/2024/opa-registration/blog.opa.png" /><meta property="twitter:title" content="OPA for User Registration" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@kepuss13" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Michal Kepkowski","url":"https://www.linkedin.com/in/michalkepkowski/"},"dateModified":"2024-11-26T03:54:59+00:00","datePublished":"2024-06-30T04:00:00+00:00","description":"Open Policy Engine (OPA) for user registration.","headline":"OPA for User Registration","image":"/assets/img/2024/opa-registration/blog.opa.png","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/opa-registration/"},"url":"/posts/opa-registration/"}</script><title>OPA for User Registration | CyberSoup</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="CyberSoup"><meta name="application-name" content="CyberSoup"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.2/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.27.20/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { let self = this;this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { self.clearMode(); } self.notify(); }); if (!this.hasMode) { return; } if (this.isDarkMode) { this.setDark(); } else { this.setLight(); } } get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isPreferDark() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); }get modeStatus() { if (this.hasMode) { return this.mode; } else { return this.isPreferDark ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); }notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { this.clearMode(); } else { if (this.isPreferDark) { this.setLight(); } else { this.setDark(); } } this.notify(); } } const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/icon.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">CyberSoup</a></h1><p class="site-subtitle fst-italic mb-0">Your tasty cyber security snack</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/cybersoup-org" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="javascript:location.href = 'mailto:' + ['cybersoupblog','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>OPA for User Registration</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>OPA for User Registration</h1><p class="post-desc fw-light mb-4">Open Policy Engine (OPA) for user registration.</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1719720000" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jun 30, 2024 </time> </span> <span> Updated <time data-ts="1732593299" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 26, 2024 </time> </span><div class="mt-3 mb-3"> <a href="/assets/img/2024/opa-registration/blog.opa.png" class="popup img-link preview-img shimmer"><img src="/assets/img/2024/opa-registration/blog.opa.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://www.linkedin.com/in/michalkepkowski/">Michal Kepkowski</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2158 words" > <em>11 min</em> read</span></div></div></div></header><div class="content"><h2 id="background"><span class="me-2">Background</span><a href="#background" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Identity management is often far more complex in practice than it seems in theory. Simple user journeys quickly become convoluted when edge cases and exceptions are taken into account. This complexity is further amplified when identity management is being implemented for the first time in an organization, where a lack of standardization, identity silos, and poor data quality often present significant obstacles.</p><p>In many cases, organizations have multiple identity stores tied to different applications, making it difficult to establish a unified view of the user. The process of generating a “golden record” — a single, unique, and well-defined user record compiled from various fragmented sources — becomes a daunting technical challenge. This complexity is further increased when business rules are not clearly defined upfront and need to be discovered and implemented during the process. Additionally, data quality is frequently compromised due to legacy systems and the natural erosion of information over time.</p><p>Given these challenges, it is crucial to implement a robust and flexible identity management system capable of accommodating complex business rules. The system should use an approach that is both technically sound and easy to understand, minimizing issues during the translation of business logic into code. Furthermore, changes to these business rules should not necessitate a full software development lifecycle, but rather be managed as configuration changes, enabling faster and more adaptable updates.</p><p>In this article, I explore a solution implementing a centralized policy decision point based on open-source components for just-in-time user registration. Please note that this is not intended as an evidence-based evaluation but rather a description of what worked for me in solving this problem, and it may help you as well. The approach outlined below uses Open Policy Agent (OPA) as a policy engine and has been successfully deployed in production for some time.</p><h2 id="goals"><span class="me-2">Goals</span><a href="#goals" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First, let’s enumerate the goals for the system:</p><h4 id="fundamental"><span class="me-2">Fundamental</span><a href="#fundamental" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>B1. The solution needs to be production ready and verified in a real-world scenario.<br /> B2. We don’t have unlimited budget, so the solution should be cost-effective, easy to maintain and modify.</p><h4 id="functional"><span class="me-2">Functional</span><a href="#functional" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>F1. Encapsulate business logic in a separate component with easy interface.<br /> F2. Enable complex logic on user attributes and relations between them.<br /> F3. Fast JIT decision what actions identity management system should take (e.g., deny the process).<br /> F4. Generate data modification instructions for the identity management system.<br /> F5. Standardised way of defining rules, which can be extended with other use cases if needed.</p><h4 id="usability"><span class="me-2">Usability</span><a href="#usability" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>U1. Business (aka non-technical employees) can understand the logic of the policy and even define their own rules.<br /> U2. Developers can understand the process and do not have to translate business requirements into code.<br /> U3. It is easy to introduce changes to the rules and integrate with the existing IDM stack.<br /> U4. Versioning following GitOps principles.</p><h2 id="design"><span class="me-2">Design</span><a href="#design" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The high-level design of the solution is as follows:</p><ol><li>IDM aggregates data from various sources.<li>IDM creates a data bundle that represents the user.<li>Bundle is sent to the evaluation engine.<li>Evaluation engine uses the rules to make a decision.<li>Evaluation engine returns the decision and actions to IDM.</ol><p>The diagram below shows the high-level design of the solution:</p><pre><code class="language-mermaid">  flowchart LR
    A[Data Source A] &amp; B[Data Source B] &amp; C[Data Source C] -- User Data --&gt; IDM
    IDM -- Aggregated Data --&gt; EV[Evaluation engine]
    EV[Evaluation engine] -- Result --&gt; IDM
</code></pre><h2 id="proposed-solution"><span class="me-2">Proposed solution</span><a href="#proposed-solution" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Equipped with previous experience with <a href="https://www.openpolicyagent.org/docs/latest/">OPA</a> (Open Policy Agent) for access management, I want to use it for the user registration process.</p><p>OPA allows you to evaluate policies which encode business logic using the <a href="https://www.openpolicyagent.org/docs/latest/policy-language/">rego language</a>. OPA executes declarative policies completely decoupled from the application code. Any party in your system can simply trigger a REST call to OPA engine with input data for evaluation.</p><p>For example, below is a sample of a simple policy that checks access policy for API calls to the HTTP server (source <a href="https://www.openpolicyagent.org/docs/latest/http-api-authorization/#steps">OPA documentation</a>):</p><div class="language-rego highlighter-rouge"><div class="code-header"> <span data-label-text="Rego"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>
<span class="ow">package</span> <span class="n">httpapi</span><span class="p">.</span><span class="n">authz</span>

<span class="ow">import</span> <span class="n">rego</span><span class="p">.</span><span class="n">v1</span>

<span class="c1"># Bob is Alice's manager, and Betty is Charlie's.</span>
<span class="n">subordinates</span> <span class="o">:=</span> <span class="p">{</span><span class="s2">"alice"</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">"charlie"</span><span class="o">:</span> <span class="p">[],</span> <span class="s2">"bob"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"alice"</span><span class="p">],</span> <span class="s2">"betty"</span><span class="o">:</span> <span class="p">[</span><span class="s2">"charlie"</span><span class="p">]}</span>

<span class="ow">default</span> <span class="n">allow</span> <span class="o">:=</span> <span class="kc">false</span>

<span class="c1"># Allow users to get their own salaries.</span>
<span class="n">allow</span> <span class="n">if</span> <span class="p">{</span>
	<span class="n">input</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"GET"</span>
	<span class="n">input</span><span class="p">.</span><span class="n">path</span> <span class="o">==</span> <span class="p">[</span><span class="s2">"finance"</span><span class="p">,</span> <span class="s2">"salary"</span><span class="p">,</span> <span class="n">input</span><span class="p">.</span><span class="n">user</span><span class="p">]</span>
<span class="p">}</span>

<span class="c1"># Allow managers to get their subordinates' salaries.</span>
<span class="n">allow</span> <span class="n">if</span> <span class="p">{</span>
	<span class="ow">some</span> <span class="n">username</span>
	<span class="n">input</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"GET"</span>
	<span class="n">input</span><span class="p">.</span><span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"finance"</span><span class="p">,</span> <span class="s2">"salary"</span><span class="p">,</span> <span class="n">username</span><span class="p">]</span>
	<span class="n">subordinates</span><span class="p">[</span><span class="n">input</span><span class="p">.</span><span class="n">user</span><span class="p">][</span><span class="n">_</span><span class="p">]</span> <span class="o">==</span> <span class="n">username</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In this example based on the request metadata, the OPA engine makes decision to allow or deny access to the resource.</p><p>For example, the data as shown below sent for the evaluation will result with result <code class="language-plaintext highlighter-rouge">true</code>.</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="w">
  </span><span class="nl">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"finance"</span><span class="p">,</span><span class="w"> </span><span class="s2">"salary"</span><span class="p">,</span><span class="w"> </span><span class="s2">"alice"</span><span class="p">],</span><span class="w">
  </span><span class="nl">"user"</span><span class="p">:</span><span class="w"> </span><span class="s2">"alice"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>This can be easily extended to the user registration process to decide if a user should be registered or not. What about actions that should be taken by the IDM system? OPA can help with that as well. Instead of returning just <code class="language-plaintext highlighter-rouge">true</code> or <code class="language-plaintext highlighter-rouge">false</code>, the engine can return a complex JSON object that is constructed accordingly to the rules shown in the <a href="#implementation">implementation section</a>.</p><h2 id="alternatives"><span class="me-2">Alternatives</span><a href="#alternatives" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Before selecting OPA, I evaluated the approaches of building the rules engine from scratch as a native extension of the identity management system, as well as using a BPMN engine such as <a href="https://camunda.com/platform/zeebe/">Camunda Zeebe</a>.</p><p>While native implementation is tempting with its flexibility, performance and tight integration with the IDM system, it fails to deliver on the usability side. Source code typically mixes business logic with language specific constructs, making it hard to understand for non-technical (and sometimes technical) employees. On top of that, designing and implementation of the rules engine is a significant development effort increasing the cost of the solution.</p><p>My first thought of a viable solution that binds business logic and technical implementation was to use the <a href="https://www.omg.org/spec/BPMN/2.0/">BPMN</a> engine. BRPN (Business Process Model and Notation) defines an XML-based representation of the business flow and binds it with software executions. Importantly, the flow design can be defined in the graphical editor without knowing the underlying technology. While this approach might have worked, I found it too high-level for the task at hand. In my use case the logic needs to evaluate every single field of the user and make the decision. It would mean that steps of the BPMN had to be very granular which decreses performance (each one calls method in the BPMN worker) or the logic would have to be implemented in the worker which is very close to the native implementation.</p><h2 id="opa-to-the-rescue"><span class="me-2">OPA to the rescue</span><a href="#opa-to-the-rescue" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Let’s start with the evaluation of the requirements. OPA is definitely production-ready and tested by many companies (B1). The open-source version is sufficient for this use case, and the running cost is relatively <a href="https://www.openpolicyagent.org/docs/latest/policy-performance/#resource-utilization">small</a>. The policy is defined as a text file and can be modified in any editor (B2). This completes our fundamental requirements.</p><p>Regarding functional requirements, Rego files contain the entire business logic. The Rego file is evaluated in the OPA engine, a separate component (e.g., a Docker container) with a clear REST API. To get a policy decision, literally one REST API call is needed, so we have F1 covered.</p><p>In the case of F2, the Rego language is powerful; however, I must admit that, with a typical software development mindset (i.e., writing step-by-step instructions to achieve results), defining the rules might not feel intuitive. For example, there are no for loops in Rego, and if statements are declared differently than what you might be familiar with in popular languages like Java or JavaScript (see more in <a href="https://blog.openpolicyagent.org/rego-design-principle-1-syntax-should-reflect-real-world-policies-e1a801ab8bfb">rego design principles</a>). However, thanks to this design, complex policies with broad and deep execution paths can be described concisely. Conditions between static data, input data, and dynamically calculated data can be easily defined. One drawback from my experience with Rego is that it is not a full-fledged programming language, and some operations available by default or through native libraries are missing. For example, simple geofencing calculations require basic mathematical operations like sine and cosine, which are not available in Rego. However, you can extend the Rego engine by writing Go code and <a href="https://www.openpolicyagent.org/docs/latest/extensions/">including it in the OPA engine</a>. Alternatively, in my case, I queried an external service for the result using OPA’s HTTP client. Therefore, I believe that the requirement F2 is sufficiently met.</p><p>F3 is a strong point of OPA. The engine is very fast and can evaluate policies in a fraction of a second. For our complex policy (with over 2,000 lines of code), the evaluation time is between 2-4ms. Though this is not a benchmark result suitable for OPA performance comparisons, the outcome is far better than required for our use case, so F3 is met.</p><p>OPA policies are not limited to returning a single boolean value. They can return a complex JSON object. With that, you can use policy rules to construct a JSON object that orchestrates actions to be taken by the IDM system. Actions like modifying a user’s email in Active Directory or updating contact information in the CRM system can be easily defined. In my case, OPA rules were used to construct LDAP LDIF files that were later executed by the IDM system. Therefore, F4 is met.</p><p>Making complex rules simple is a challenge, and regardless of the technology, one can end up with spaghetti code. However, Rego has the advantage of flattening the logic and promoting the creation of short blocks that represent policy conditions. This contributes to the readability and standardization of rule definitions. Regarding extensibility, once created, a policy can be easily extended—up to the point that it breaks the agreed interface with the client (e.g., a new field in the response). But even then, the change is easy to introduce and does not require much effort. Therefore, F5 is met.</p><p>Now let’s look at usability. To my surprise, OPA was easy to understand for the business. Once rules are named in understandable language (e.g., is_user_in_hr_group), the rule and entire policy become more like a recipe than code. I found that after initial training, non-technical employees were able to understand the policy and even define their own rules. Therefore, in my opinion, U1 is met.</p><p>Easily understandable but technical representations of policy rules also benefit the development side. Business requirements, typically delivered as a set of plain English-described conditions, are much easier to translate into Rego code than into native code. The reverse is also true: once requirements are expressed in Rego, it is easier to perform reverse reasoning and understand the business logic. Therefore, U2 is met.</p><p>Regarding U3, I have already discussed policy updates and integration via a single REST call. In terms of versioning (U4), rego files are text files that can be easily versioned using Git.</p><h3 id="implementation-examples"><span class="me-2">Implementation examples</span><a href="#implementation-examples" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Below, I share a few samples of how the policy can be implemented. PLease note that those exmaples are not complete and are simplified for the purpose of this article.</p><p><strong>Ex1.</strong> The policy is designed to have a single entry point. Below, you can see a rule called <code class="language-plaintext highlighter-rouge">decision</code>, which has a similar function as the main method in many programming languages. It is executed directly from the REST API, and defines the structure of the response. It aggregates results from other rules into a single JSON body.</p><div class="language-rego highlighter-rouge"><div class="code-header"> <span data-label-text="Rego"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">decision</span> <span class="o">:=</span> <span class="n">response</span> <span class="p">{</span>
    <span class="n">response</span> <span class="o">:=</span>
    <span class="p">{</span>
        <span class="s2">"ruleImplemented"</span><span class="o">:</span><span class="n">rule_implemented</span><span class="p">,</span>
        <span class="s2">"input"</span><span class="o">:</span> <span class="n">policy_input</span><span class="p">,</span>
        <span class="s2">"ldap"</span><span class="o">:</span> <span class="n">ldap</span><span class="p">,</span>
        <span class="s2">"error"</span><span class="o">:</span> <span class="n">error</span><span class="p">,</span>
        <span class="s2">"warn"</span><span class="o">:</span> <span class="n">warn</span><span class="p">,</span>
        <span class="s2">"metadata"</span><span class="o">:</span> <span class="n">metadata</span><span class="p">,</span>
        <span class="s2">"version"</span><span class="o">:</span> <span class="n">policy_version</span><span class="p">,</span>
        <span class="s2">"timestamp"</span><span class="o">:</span> <span class="n">time</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">now_ns</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Ex2.</strong> The policy also runs the check of the data quality. If something is wrong the warning message is added to the response. A similar approach is done for errors.</p><div class="language-rego highlighter-rouge"><div class="code-header"> <span data-label-text="Rego"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">warn</span><span class="p">[</span><span class="n">warn</span><span class="p">]</span> <span class="p">{</span>
  <span class="n">user_is_in_ldap</span>
  <span class="n">count</span><span class="p">(</span><span class="n">ldap_attribute_x</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span>
  <span class="n">warn</span> <span class="o">:=</span> <span class="s2">"MISSING_LDAP_ATTRIBUTE_X: LDAP data is missing the x attribute"</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>Ex3.</strong> As I mentioned before, the policy also creates steps for other systems to execute. The example below shows how an ldif modify instruction is created for an LDAP system.</p><div class="language-rego highlighter-rouge"><div class="code-header"> <span data-label-text="Rego"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="n">ldap</span> <span class="o">:=</span> <span class="n">ldap_recs</span> <span class="p">{</span>
	<span class="n">ldap_recs</span> <span class="o">:=</span> <span class="p">{</span>
		<span class="s2">"roles"</span><span class="o">:</span><span class="p">[{</span>
			<span class="s2">"dn"</span><span class="o">:</span> <span class="s2">"cn=member,ou=roles,dc=example,dc=com"</span><span class="p">,</span>
			<span class="s2">"changetype"</span><span class="o">:</span> <span class="s2">"modify"</span><span class="p">,</span>
			<span class="s2">"add"</span><span class="o">:</span> <span class="s2">"member"</span><span class="p">,</span>
			<span class="s2">"member"</span><span class="o">:</span> <span class="n">concat</span><span class="p">(</span><span class="s2">","</span><span class="p">,[</span><span class="n">concat</span><span class="p">(</span><span class="s2">"="</span><span class="p">,[</span><span class="s2">"uid"</span><span class="p">,</span><span class="n">input</span><span class="p">.</span><span class="n">username</span><span class="p">]),</span><span class="s2">"ou=users,ou=external,dc=example,dc=com"</span><span class="p">])</span>
		<span class="p">}]</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><h2 id="summary"><span class="me-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In this article, I demonstrated how Open Policy Agent (OPA) can be used to implement centralized policy evaluation for just-in-time user registration. The solution is production-ready, cost-effective, and easy to maintain and modify. Additionally, it has the potential to be extended to other use cases, which I am currently exploring.</p><p>The key takeaways are that, despite an initial learning curve, OPA and its Rego language offer powerful capabilities for implementing complex business logic. Another important point is that OPA can return more than just policy decisions, offering flexibility in its responses. Finally, I believe that the simplicity of Rego’s syntax, combined with well-structured naming conventions, can significantly reduce the gap between business requirements and technical implementation, minimizing friction and misunderstandings.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/authorization/">Authorization</a>, <a href="/categories/iam/">IAM</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/opa/" class="post-tag no-text-decoration" >OPA</a> <a href="/tags/intermediate/" class="post-tag no-text-decoration" >Intermediate</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=OPA%20for%20User%20Registration%20-%20CyberSoup&url=%2Fposts%2Fopa-registration%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=OPA%20for%20User%20Registration%20-%20CyberSoup&u=%2Fposts%2Fopa-registration%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fopa-registration%2F&text=OPA%20for%20User%20Registration%20-%20CyberSoup" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/pitfalls-passkey/">Developer's confession, building a custom passkey authenticator</a><li class="text-truncate lh-lg"> <a href="/posts/WICYS-workshop/">WiCyS 2025 Workshop - Phishing Resistance of Passkeys</a><li class="text-truncate lh-lg"> <a href="/posts/secret-zero/">Keeping secrets secret</a><li class="text-truncate lh-lg"> <a href="/posts/GIAC-notes/">Cybersecurity - the longest journey</a><li class="text-truncate lh-lg"> <a href="/posts/opa-registration/">OPA for User Registration</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/intermediate/">Intermediate</a> <a class="post-tag btn btn-outline-primary" href="/tags/wicys/">WiCyS</a> <a class="post-tag btn btn-outline-primary" href="/tags/appsec/">AppSec</a> <a class="post-tag btn btn-outline-primary" href="/tags/cissp/">CISSP</a> <a class="post-tag btn btn-outline-primary" href="/tags/giac/">GIAC</a> <a class="post-tag btn btn-outline-primary" href="/tags/opa/">OPA</a> <a class="post-tag btn btn-outline-primary" href="/tags/passkey/">Passkey</a> <a class="post-tag btn btn-outline-primary" href="/tags/sans/">SANS</a></div></section></div><section id="toc-wrapper" class="d-none ps-0 pe-4"><h2 class="panel-heading ps-3 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/secret-zero/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1734580800" data-df="ll" > Dec 19, 2024 </time><h4 class="pt-0 my-2">Keeping secrets secret</h4><div class="text-muted"><p>Introduction Software development is often seen as a blend of engineering and art — a creative process where developers work within the boundaries of project requirements, timelines, technological...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"><div class="btn btn-outline-primary disabled" aria-label="Older"><p>-</p></div><a href="/posts/cissp-notes/" class="btn btn-outline-primary" aria-label="Newer" ><p>CISSP thoughts & notes</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/username">CyberSoup</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p></p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/intermediate/">Intermediate</a> <a class="post-tag btn btn-outline-primary" href="/tags/wicys/">WiCyS</a> <a class="post-tag btn btn-outline-primary" href="/tags/appsec/">AppSec</a> <a class="post-tag btn btn-outline-primary" href="/tags/cissp/">CISSP</a> <a class="post-tag btn btn-outline-primary" href="/tags/giac/">GIAC</a> <a class="post-tag btn btn-outline-primary" href="/tags/opa/">OPA</a> <a class="post-tag btn btn-outline-primary" href="/tags/passkey/">Passkey</a> <a class="post-tag btn btn-outline-primary" href="/tags/sans/">SANS</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.11/dayjs.min.js,npm/dayjs@1.11.11/locale/en.min.js,npm/dayjs@1.11.11/plugin/relativeTime.min.js,npm/dayjs@1.11.11/plugin/localizedFormat.min.js,npm/tocbot@4.27.20/dist/tocbot.min.js,npm/mermaid@10.9.0/dist/mermaid.min.js"></script> <script src="/assets/js/dist/post.min.js"></script> <script src="/assets/js/data/mathjax.js"></script> <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-chtml.js"></script> <script type="text/javascript"> function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === 'undefined') { return; } let expectedTheme = mode === ModeToggle.DARK_MODE ? 'dark' : 'default'; let config = { theme: expectedTheme };const mermaidList = document.getElementsByClassName('mermaid'); [...mermaidList].forEach((elem) => { const svgCode = elem.previousSibling.children.item(0).innerHTML; elem.innerHTML = svgCode; elem.removeAttribute('data-processed'); }); mermaid.initialize(config); mermaid.init(undefined, '.mermaid'); } } (function () { let initTheme = 'default'; const html = document.documentElement; if ( (html.hasAttribute('data-mode') && html.getAttribute('data-mode') === 'dark') || (!html.hasAttribute('data-mode') && window.matchMedia('(prefers-color-scheme: dark)').matches) ) { initTheme = 'dark'; } let mermaidConf = { theme: initTheme};const basicList = document.getElementsByClassName('language-mermaid'); [...basicList].forEach((elem) => { const svgCode = elem.textContent; const backup = elem.parentElement; backup.classList.add('d-none');let mermaid = document.createElement('pre'); mermaid.classList.add('mermaid'); const text = document.createTextNode(svgCode); mermaid.appendChild(text); backup.after(mermaid); }); mermaid.initialize(mermaidConf); window.addEventListener('message', updateMermaid); })(); </script> <script defer src="/assets/js/dist/app.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-DG1HHNCFDD"></script> <script> document.addEventListener('DOMContentLoaded', function (event) { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'G-DG1HHNCFDD'); }); </script> <script>SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
